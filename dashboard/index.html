<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vehicle Ease Pro</title>
  <style>
    body { background: #000; color: #0f0; font-family: 'Courier New', monospace; padding: 20px; margin: 0; }
    h1 { text-align: center; animation: pulse 2s infinite; margin-bottom: 30px; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }
    .gauge { background: #111; border: 3px solid #0f0; padding: 20px; margin: 15px; border-radius: 15px; text-align: center; }
    .bar-container { background: #222; height: 25px; border-radius: 10px; margin: 10px 0; overflow: hidden; }
    .bar { height: 100%; background: #0f0; transition: width 0.3s; border-radius: 10px; }
    .big { font-size: 42px; font-weight: bold; margin: 10px 0; }
    .medium { font-size: 28px; font-weight: bold; margin: 5px 0; }
    .status { text-align: center; margin: 20px; font-size: 18px; }
    .connected { color: #0f0; }
    .disconnected { color: #f00; }
    .container { max-width: 500px; margin: 0 auto; }
    .gear-indicator {
      display: inline-block;
      width: 30px;
      height: 30px;
      line-height: 30px;
      text-align: center;
      margin: 2px;
      background: #222;
      border: 1px solid #333;
      border-radius: 5px;
      font-weight: bold;
    }
    .gear-active {
      background: #00ff00;
      color: #000;
      border-color: #00ff00;
    }
    .fuel-efficiency { color: #00ff00; }
    .fuel-warning { color: #ffaa00; }
    .fuel-critical { color: #ff4444; }
    .reset-btn {
      background: #333;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    .reset-btn:hover {
      background: #0f0;
      color: #000;
    }
    .fuel-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .fuel-stat {
      background: #222;
      padding: 8px;
      border-radius: 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸš— VEHICLE EASE PRO</h1>
    
    <div class="status" id="status">Connecting...</div>
    
    <div class="gauge">
      <div>ENGINE RPM</div>
      <div id="rpm" class="big">0</div>
      <div class="bar-container"><div class="bar" id="rpmBar" style="width: 0%"></div></div>
      <div>0 - 8000 RPM</div>
    </div>
    
    <div class="gauge">
      <div>COOLANT TEMP</div>
      <div id="coolant" class="big">0 Â°C</div>
      <div class="bar-container"><div class="bar" id="coolantBar" style="width: 0%"></div></div>
      <div>0Â° - 120Â°C</div>
    </div>
    
    <div class="gauge">
      <div>THROTTLE POSITION</div>
      <div id="throttle" class="big">0 %</div>
      <div class="bar-container"><div class="bar" id="throttleBar" style="width: 0%"></div></div>
      <div>0 - 100%</div>
    </div>
    
    <div class="gauge">
      <div>VEHICLE SPEED</div>
      <div id="speed" class="big">0 km/h</div>
      <div class="bar-container"><div class="bar" id="speedBar" style="width: 0%"></div></div>
      <div>0 - 300 km/h</div>
    </div>
    
    <!-- NEW: Fuel Efficiency Gauge -->
    <div class="gauge">
      <div>FUEL EFFICIENCY</div>
      <div id="fuelEfficiency" class="big fuel-efficiency">0.0 km/L</div>
      <div class="bar-container">
        <div class="bar" id="fuelBar" style="width: 0%; background: #00ff00"></div>
      </div>
      <div class="fuel-stats">
        <div class="fuel-stat">
          <div>Fuel Rate</div>
          <div id="fuelRate" class="medium">0.0 L/h</div>
        </div>
        <div class="fuel-stat">
          <div>Trip Fuel</div>
          <div id="tripFuel" class="medium">0.0 L</div>
        </div>
        <div class="fuel-stat">
          <div>Trip Cost</div>
          <div id="tripCost" class="medium">$0.00</div>
        </div>
        <div class="fuel-stat">
          <div>Efficiency</div>
          <div id="efficiencyStatus" class="medium">Good</div>
        </div>
      </div>
      <button class="reset-btn" onclick="resetTrip()">Reset Trip</button>
    </div>
        
    <div class="gauge">
      <div>CURRENT GEAR</div>
      <div id="gear" class="big" style="font-size: 60px; color: #00ff00;">N</div>
      <div style="margin-top: 10px;">
        <span id="gearR" class="gear-indicator">R</span>
        <span id="gear1" class="gear-indicator">1</span>
        <span id="gear2" class="gear-indicator">2</span>
        <span id="gear3" class="gear-indicator">3</span>
        <span id="gear4" class="gear-indicator">4</span>
        <span id="gear5" class="gear-indicator">5</span>
        <span id="gear6" class="gear-indicator">6</span>
      </div>
    </div>
  </div>

  <script>
    class VehicleDashboard {
      constructor() {
        this.ws = null;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.connect();
      }

      connect() {
        // Auto-detect current host
        const host = window.location.hostname || 'localhost';
        const wsUrl = `ws://${host}:8765`;
        
        console.log(`Connecting to: ${wsUrl}`);
        this.ws = new WebSocket(wsUrl);
        
        this.ws.onopen = () => {
          console.log("Connected to vehicle data!");
          this.reconnectAttempts = 0;
          this.updateStatus('Connected to Vehicle', 'connected');
        };
        
        this.ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            this.updateDisplay(data);
          } catch (e) {
            console.error('Data error:', e);
          }
        };
        
        this.ws.onclose = () => {
          console.log('Connection closed');
          this.updateStatus('Disconnected - Retrying...', 'disconnected');
          this.attemptReconnect();
        };
        
        this.ws.onerror = (error) => {
          console.error('WebSocket error:', error);
          this.updateStatus('Connection Error', 'disconnected');
        };
      }

      attemptReconnect() {
        if (this.reconnectAttempts < this.maxReconnectAttempts) {
          this.reconnectAttempts++;
          setTimeout(() => {
            console.log(`Reconnect attempt ${this.reconnectAttempts}`);
            this.connect();
          }, 2000);
        } else {
          this.updateStatus('Failed to connect. Check if server is running.', 'disconnected');
        }
      }

      updateStatus(message, className) {
        const statusEl = document.getElementById('status');
        statusEl.textContent = message;
        statusEl.className = `status ${className}`;
      }

      updateGearDisplay(data) {
        // Use gear from server data if available, otherwise calculate
        let gear = data.gear || "N";
        if (!data.gear && data.speed > 0 && data.rpm > 800) {
          const ratio = data.rpm / data.speed;
          if (ratio > 300) gear = "1";
          else if (ratio > 200) gear = "2";
          else if (ratio > 150) gear = "3";
          else if (ratio > 120) gear = "4";
          else if (ratio > 100) gear = "5";
          else gear = "6";
        } else if (!data.gear && data.speed < 0) {
          gear = "R";
        }

        // Update gear display
        document.getElementById('gear').textContent = gear;
        
        // Update gear indicators
        const gears = ['R', '1', '2', '3', '4', '5', '6'];
        gears.forEach(g => {
          const element = document.getElementById('gear' + g);
          if (element) {
            if (g === gear) {
              element.classList.add('gear-active');
            } else {
              element.classList.remove('gear-active');
            }
          }
        });
      }

      updateFuelDisplay(data) {
        // Fuel efficiency (km/L)
        const efficiency = data.fuel_efficiency || 0;
        document.getElementById('fuelEfficiency').textContent = efficiency.toFixed(1) + ' km/L';
        
        // Fuel rate (L/h)
        document.getElementById('fuelRate').textContent = (data.fuel_rate || 0).toFixed(1) + ' L/h';
        
        // Trip fuel (L)
        document.getElementById('tripFuel').textContent = (data.trip_fuel || 0).toFixed(2) + ' L';
        
        // Trip cost
        document.getElementById('tripCost').textContent = '$' + (data.trip_cost || 0).toFixed(2);
        
        // Efficiency status and color coding
        const efficiencyElement = document.getElementById('fuelEfficiency');
        const statusElement = document.getElementById('efficiencyStatus');
        const fuelBar = document.getElementById('fuelBar');
        
        // Efficiency bar (0-30 km/L scale)
        const efficiencyPercent = Math.min(100, (efficiency / 30) * 100);
        fuelBar.style.width = efficiencyPercent + '%';
        
        if (efficiency > 15) {
          // Excellent efficiency
          efficiencyElement.className = 'big fuel-efficiency';
          statusElement.textContent = 'Excellent';
          statusElement.className = 'medium fuel-efficiency';
          fuelBar.style.background = '#00ff00';
        } else if (efficiency > 10) {
          // Good efficiency
          efficiencyElement.className = 'big fuel-warning';
          statusElement.textContent = 'Good';
          statusElement.className = 'medium fuel-warning';
          fuelBar.style.background = '#ffaa00';
        } else if (efficiency > 5) {
          // Poor efficiency
          efficiencyElement.className = 'big fuel-warning';
          statusElement.textContent = 'Poor';
          statusElement.className = 'medium fuel-warning';
          fuelBar.style.background = '#ffaa00';
        } else {
          // Very poor efficiency
          efficiencyElement.className = 'big fuel-critical';
          statusElement.textContent = 'Very Poor';
          statusElement.className = 'medium fuel-critical';
          fuelBar.style.background = '#ff4444';
        }
        
        // Special case for idle/stationary
        if (data.speed === 0 && efficiency === 0) {
          statusElement.textContent = 'Idle';
          fuelBar.style.width = '10%';
        }
      }

      updateDisplay(data) {
        // RPM (0-8000)
        document.getElementById('rpm').textContent = data.rpm.toLocaleString();
        document.getElementById('rpmBar').style.width = Math.min(100, (data.rpm / 8000 * 100)) + '%';
        
        // Coolant Temp (0-120Â°C)
        document.getElementById('coolant').textContent = data.coolant + ' Â°C';
        document.getElementById('coolantBar').style.width = Math.min(100, (data.coolant / 120 * 100)) + '%';
        
        // Throttle Position (0-100%)
        document.getElementById('throttle').textContent = data.throttle + ' %';
        document.getElementById('throttleBar').style.width = Math.min(100, data.throttle) + '%';
        
        // Speed (0-300 km/h)
        document.getElementById('speed').textContent = data.speed + ' km/h';
        document.getElementById('speedBar').style.width = Math.min(100, (data.speed / 300 * 100)) + '%';
        
        // Gear display
        this.updateGearDisplay(data);
        
        // Fuel efficiency display
        this.updateFuelDisplay(data);
        
        // Visual feedback for high values
        this.updateVisualFeedback(data);
      }

      updateVisualFeedback(data) {
        const rpmBar = document.getElementById('rpmBar');
        if (data.rpm > 6000) {
          rpmBar.style.background = '#ff4444';
        } else if (data.rpm > 4000) {
          rpmBar.style.background = '#ffaa00';
        } else {
          rpmBar.style.background = '#00ff00';
        }

        const coolantBar = document.getElementById('coolantBar');
        if (data.coolant > 100) {
          coolantBar.style.background = '#ff4444';
        } else if (data.coolant > 90) {
          coolantBar.style.background = '#ffaa00';
        } else {
          coolantBar.style.background = '#00ff00';
        }
      }
    }

    // Reset trip data
    async function resetTrip() {
      try {
        const response = await fetch('http://localhost:8766/trip/reset', {
          method: 'POST'
        });
        if (response.ok) {
          console.log('Trip data reset');
        }
      } catch (error) {
        console.error('Failed to reset trip:', error);
      }
    }

    // Initialize dashboard when page loads
    document.addEventListener('DOMContentLoaded', () => {
      new VehicleDashboard();
    });
  </script>
</body>
</html>